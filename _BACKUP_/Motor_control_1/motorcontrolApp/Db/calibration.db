record(bo, "$(P)CalibrateStart") {
    field(DESC, "Trigger motor calibration")
    field(ZNAM, "IDLE")
    field(ONAM, "START")
    field(FLNK, "$(P)GoToZero")
}

record(ao, "$(P)ZeroPos") {
    field(DESC, "Set zero point position")
    field(VAL, -10000)
}

record(ao, "$(P)MaxPosGuess") {
    field(DESC, "Guess for max travel")
    field(VAL, 1000000)
}

record(calcout, "$(P)GoToZero") {
    field(DESC, "Move to zero position")
    field(INPA, "$(P)ZeroPos")
    field(CALC, "A")
    field(OUT, "$(MOTOR).VAL PP")
    field(OOPT, "Every Time")
    field(FLNK, "$(P)WaitForStop1")
}

record(busy, "$(P)BusyCalib") {
    field(DESC, "Calibration in progress")
    field(BUSY, "1")
}

record(waveform, "$(P)WaitTimer") {
    field(DESC, "Dummy wait timer")
    field(NELM, 1)
    field(FTVL, "SHORT")
}

record(calcout, "$(P)WaitForStop1") {
    field(DESC, "Wait until motor stops moving")
    field(INPA, "$(MOTOR).MOVN")
    field(CALC, "A=0")
    field(SCAN, "1 second")
    field(OUT, "$(P)SetZero")
    field(OOPT, "Transition To Non-zero")
}

record(seq, "$(P)SetZero") {
    field(DESC, "Set position to zero")
    field(OUT, "$(MOTOR).SET PP NMS")
    field(DOL, "1")
    field(FLNK, "$(P)DoZeroVAL")
}

record(seq, "$(P)DoZeroVAL") {
    field(DESC, "Set VAL to 0")
    field(DOL, "0")
    field(OUT, "$(MOTOR).VAL PP NMS")
    field(FLNK, "$(P)UnsetZero")
}

record(seq, "$(P)UnsetZero") {
    field(DESC, "Reset SET mode")
    field(DOL, "0")
    field(OUT, "$(MOTOR).SET PP NMS")
    field(FLNK, "$(P)GoToMax")
}

record(calcout, "$(P)GoToMax") {
    field(DESC, "Move to guessed max position")
    field(INPA, "$(P)MaxPosGuess")
    field(CALC, "A")
    field(OUT, "$(MOTOR).VAL PP")
    field(OOPT, "Every Time")
    field(FLNK, "$(P)WaitForStop2")
}

record(calcout, "$(P)WaitForStop2") {
    field(DESC, "Wait for max move stop")
    field(INPA, "$(MOTOR).MOVN")
    field(CALC, "A=0")
    field(SCAN, "1 second")
    field(OUT, "$(P)StoreRBV")
    field(OOPT, "Transition To Non-zero")
}

record(ai, "$(P)RBVcopy") {
    field(DESC, "Copy of final RBV")
    field(INP, "$(MOTOR).RBV CPP")
    field(SCAN, "Passive")
}

record(calcout, "$(P)StoreRBV") {
    field(DESC, "Store final RBV as HLM")
    field(INPA, "$(MOTOR).RBV CPP")
    field(OUT, "$(MOTOR).HLM PP")
    field(FLNK, "$(P)SetLLM")
}

record(calcout, "$(P)SetLLM") {
    field(DESC, "Set LLM to 0")
    field(CALC, "0")
    field(OUT, "$(MOTOR).LLM PP")
    field(FLNK, "$(P)CalibrationDone")
}

record(bo, "$(P)CalibrationDone") {
    field(DESC, "Calibration finished")
    field(VAL, 1)
    field(FLNK, "$(P)BusyCalibDone")
}

record(bo, "$(P)BusyCalibDone") {
    field(DESC, "Clear busy flag")
    field(OUT, "$(P)BusyCalib.BUSY PP")
    field(DOL, "0")
}
